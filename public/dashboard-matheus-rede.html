<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css" />
    <link rel="stylesheet" href="./css/dashboard-matheus-cpu.css">

</head>

<body onload="funcaoGeral()">

    <header>
        <div class="opcoes">
            <div class="esq">
                <div class="logo">
                    <img href="index.html" src="./src/img/logoB.png" alt="logo">
                </div>

                <div class="opcoesComponentes" id="itens">
                    <h6 class="opcoesMenu associMenu"> Olá, <span id="b_usuario">usuário </span>! </h6>  
                    <h6 class="opcoesMenu associMenu"  onclick="window.location.href='pagina-maquina.html'">Dispositivos </h6>
                </div>
            </div>

            <div class="sair">
                <h6 class="opcoesMenu sair" onclick="sair()"> Sair </h6>
            </div>
        </div>
    </header>


    <div class="corpo"> 
        <div class="infos">
            <!-- Parte superior das Informações-->
            <div class="emcima">
                <span> Monitoramento de REDE!</span>
                <select name="opcoes" class="dropdown" id="seletorPaginas">
                    <option value="dashboard-matheus-rede.html">REDE</option>
                    <option value="dashboard-matheus-cpu.html">CPU</option>
                    <option value="dashboard-matheus-ram.html">RAM</option>
                    <option value="dashboard-matheus-disco.html">DISCO</option>
                </select>
            </div>



            <div class="embaixo">
              <!--Esquerda embaixo  -->
              <div class="esquerda">
                  <!-- Gráfico maior à esquerda -->
                  <div class="card grande">
                    <div class="monitoramento">
                      <div class="monitoramento-card">
                          <div class="info-monit">
                              <table id="minhaTabela">
                                  <thead>
                                      <tr>
                                          <th>Maquina</th>
                                          <th>Equipe</th>
                                          <th>Modelo da Placa de Rede</th>
                                          <th>Quantidade de alertas</th>
                                          
                                      </tr>
                                  </thead>
                                  <tbody id="tbody_corpo_tabela">
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
                  </div>
          
                  <!-- Dois gráficos menores ao lado direito -->
                  <div class="direitaCards">
                    <div class="card pequeno">
                        <h3 style="color: white;"> Quantidade de alertas: </h3>
                        <div class="card-numero">


                        </div>
                      </div>
                      <div class="card pequeno">
                        <h3 style="color: white;"> Máquinas com alertas: </h3>
                        <div class="card-numero2">


                        </div>
                      </div>
                  </div>
              </div>
          
              <!-- Alertas à direita -->
              <div class="direita">
                  <h1 style="color: white;"> Alertas Gerais </h1>
                  <div class="box">
                      <p><b style="color: red;"></b></p>
                  </div>
                  <div class="box">
                      <p><b style="color: orange;"></b></p>
                  </div>
              </div>
          </div>
          
        </div>
    </div>
</body>

</html>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>


<script>
b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
let fkEmpresa = sessionStorage.getItem("ID_EMPRESA")

function funcaoGeral(){

obterDadosGrafico();
buscarNumerosRede();
buscarMaquinasRede();
mensagemAlerta();

}

function obterDadosGrafico() {

fetch(`/redesMatheus/listarPacotes/${fkEmpresa}`, { cache: 'no-store' }).then(function (resposta) {

if (resposta.ok) {
    if (resposta.status == 204) {
        throw "Nenhum resultado encontrado!!";
    }

    resposta.json().then(function (resposta) {
    console.log("Dados recebidos: ", JSON.stringify(resposta));

    console.log(resposta)

    const bodyTabela = document.getElementById('tbody_corpo_tabela')

    let enderecoPerigo = 0;

        for (let i = 0; i < resposta.length; i++) {
            
            let linha = document.createElement('tr');
            // linha.dataset.idEndereco = resposta[i].id;
            // linha.dataset.nomeEndereco = resposta[i].nome;

            bodyTabela.appendChild(linha)
                
            let linhaAtual = resposta[i];

            let conteudoMaquina = linhaAtual.fkComputador; 
            
            let celMaquina = document.createElement('td');
            celMaquina.textContent = conteudoMaquina;
            linha.appendChild(celMaquina);

            let conteudoEquipe = linhaAtual.nome; 
            let celEquipe = document.createElement('td');
            celEquipe.textContent = `${conteudoEquipe}`;
            linha.appendChild(celEquipe);

            let conteudoModelo = linhaAtual.modelo;
            
            let celModelo = document.createElement('td');
            celModelo.textContent = `${conteudoModelo}`
            linha.appendChild(celModelo);
        
            let conteudoAlertas = linhaAtual.quantidade_alertas;
                
                let celAlertas = document.createElement('td');
                celAlertas.textContent = `${conteudoAlertas}`
                linha.appendChild(celAlertas);


        }
     // script do objeto 
                $(document).ready(function () {
                    $('#minhaTabela').DataTable({
                        dom: '<"custom-header"lf>rt<"custom-footer"ip>',
                        pageLength: 5,
                        lengthMenu: [5, 10, 25, 50, 100],
                        language: {
                            info: 'Páginas _PAGE_ de _PAGES_',
                            infoEmpty: 'Nenhum registro disponível',
                            infoFiltered: '(filtrado de _MAX_ registros totais)',
                            lengthMenu: '_MENU_ Registros por páginas',
                            zeroRecords: 'Nada encontrado',
                            search: "",  // Desativa o label do input de busca
                            searchPlaceholder: "Digite para buscar...",  // Placeholder do input de busca
                            paginate: {
                                previous: "Anterior",
                                next: "Próximo"
                            }
                        },
                    });
                });
            });
} else {
    throw ('Houve um erro na API!');
}
})
  .catch(function (error) {
    console.error(`Erro na obtenção dos dados p/ gráfico: ${resposta}`);
  });
}



document.getElementById('seletorPaginas').addEventListener('change', function() {
    const paginaSelecionada = this.value;
    window.location.href = paginaSelecionada; 
});


function buscarNumerosRede() {

fetch(`/redesMatheus/numerosBuscarRede/:fkComponente`) 
    .then(response => {
        if (!response.ok) {
            throw new Error("Erro ao buscar o número total de servidores");
        }
        return response.json();
    })
    .then(data => {
        // Acessando o valor da chave 'count(*)' do primeiro objeto
        const Quantidade_Alertas = data[0].quantidade_alertas;
        document.querySelector(".card-numero").textContent = Quantidade_Alertas;
    })
    .catch(error => {
        console.error("Erro:", error);
    });
}


function buscarMaquinasRede() {

fetch(`/redesMatheus/maquinasBuscarRede/:fkComponente`) 
    .then(response => {
        if (!response.ok) {
            throw new Error("Erro ao buscar o número total de servidores");
        }
        return response.json();
    })
    .then(data => {
        // Acessando o valor da chave 'count(*)' do primeiro objeto
        const Quantidade_Alertas = data[0].quantidade_maquinas_com_alertas;
        document.querySelector(".card-numero2").textContent = Quantidade_Alertas;
    })
    .catch(error => {
        console.error("Erro:", error);
    });
}


function mensagemAlerta(){
    fetch(`/enderecos/funcaoGeral/:fkComponente`) 
    .then(response => {
        if (!response.ok) {
            throw new Error("Erro ao buscar o número total de servidores");
        }
        return response.json();
    })
    .then(data => {
        // Limpa o conteúdo atual das divs de alerta
        const container = document.querySelector('.direita');
        container.innerHTML = ''; // Limpa o container para não duplicar as mensagens
        container.innerHTML = '<h1 style="color: white;"> Alertas Gerais </h1>'; // Adiciona o título
        console.log(data)

        // Itera sobre os dados de alerta recebidos
        data.forEach(alerta => {
            // Cria uma nova div para cada alerta
            const div = document.createElement("div");
            div.className = "box"; // Adiciona a classe "box" para estilização

            // Cria o elemento <p> para o texto do alerta
            const p = document.createElement("p");

            // O texto do alerta está no banco de dados
            let alertMessage = alerta.mensagemAlerta;
            console.log(alertMessage)
            // Encontra o nome do componente na mensagem (ex: "CPU")
            var nomeComponente = alerta.fkComponente;
            console.log(nomeComponente) // Aqui você pode ajustar para pegar o nome do componente dinamicamente

            // Verifica o tipo de alerta para decidir a cor
            const tipoAlerta = alerta.tipoAlerta; // 1 para normal, 2 para crítico

            // Substitui a palavra do componente pela palavra com a cor
            if (tipoAlerta === "red") {
                alertMessage = alertMessage.replace(`<p style="color: red;">${nomeComponente}</p>`);
            } else if (tipoAlerta === "yellow") {
                alertMessage = alertMessage.replace(`<p style="color: orange;">${nomeComponente}</p>`);
            }

            // Converte a string HTML em elementos DOM
            p.innerHTML = alertMessage;  // Usando innerHTML para aplicar a cor ao componente

            // Adiciona o elemento <p> à div
            div.appendChild(p);

            // Adiciona a nova div ao container
            container.appendChild(div);
        });
    })
    .catch(error => {
        console.error("Erro:", error);
    });
}



</script>