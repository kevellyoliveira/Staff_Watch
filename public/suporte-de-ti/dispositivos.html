<!DOCTYPE html>
<html lang="ptbr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href=".././css/dashboardDispositivos.css">
    <!-- style do input de pesquisa -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="shortcut icon" href=".././src/img/logoB.png" type="image/x-icon" />

    <title> Dispositivos | Staff Watch</title>
</head>

<body onload="atualizarFeed()">
    <header>
        <div class="opcoes">
            <div class="esq">
                <div class="logo">
                    <img href="index.html" src=".././src/img/logoB.png" alt="logo">
                </div>

                <div class="menuCima" id="itens">
                    <h6 class="opcoesMenu user"> Olá, <span id="b_usuario">usuário</span>! </h6>
                </div>
                <div class="menuCima op2" id="itens">
                    <h6 class="opcoesMenu slct" onclick="window.location.href='dispositivos.html'">Dispositivos</h6>
                    <h6 class="opcoesMenu" onclick="window.location.href='../dashboard-matheus-cpu.html'">Componentes
                    </h6>
                </div>
            </div>

            <div class="sair">
                <h6 class="opcoesMenu sair" onclick="sair()"> Sair </h6>
            </div>
        </div>
    </header>
    <div class="corpo">
        <!-- <div class="menuLateral">
            <div class="itens">
                <h4 id="1" onclick="window.location.href='../dashboard-matheus-cpu.html'"> CPU </h4>
                <h4 id="2" onclick="window.location.href='../dashboard-matheus-disco.html'">Disco</h4>
                <h4 id="3" onclick="window.location.href='../dashboard-matheus-rede.html'">Rede</h4>
                <h4 id="4" onclick="window.location.href='../dashboard-matheus-ram.html'">RAM</h4>
            </div>
        </div> -->

        <main class="main-section">
            <!-- <section class="section-grafico">
                <h4> Quantidade de alertas por componente em cada equipe </h4>
                <div class="grafico">
                    <canvas id="graficoEquipe"></canvas>
                </div>
            </section> -->

            <article class="title">
                <!-- <div class="filtros">
                    <div class="filtro">
                        <h3>Exibir alerta mais recente de:</h3>
                        <select name="opcoes" class="selectFiltro" id="seletorFiltro">
                            <option value="1h">Última 1 hora</option>
                            <option value="3h">Últimas 3 horas</option>
                            <option value="24h">Últimas 24 horas</option>
                        </select>
                    </div>
                    <div class="filtro">
                        <h3>Exibir alerta mais recente do tipo: </h3>
                        <select name="opcoesAlerta" class="selectFiltro" id="seletorFiltroAlerta">
                            <option value="total">Todos</option>
                            <option value="amarelo">Amarelo</option>
                            <option value="vermelho">Vermelho</option>
                        </select>
                    </div>
                </div> -->

                <div class="pesquisa">
                    <input type="text" name="Pesquisar" id="pesquisar_input" required="required" autocomplete="off"
                        placeholder="Pesquisar máquina pelo ID" onkeyup="listarPorUsuario()"><button
                        onclick="listarPorUsuario()"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
            </article>

            <section class="sectioncard" id="sectioncard">
                <span id="spanMensagem"></span>

                <!-- <div class="card open-modal" onclick="alterarComponente('dashCpu')">

                    <div class="down-card cima">
                        <div class="esqCard">
                            <figure class="iconComp">
                                <img src=".././src/img/icons/indicadoresMaquina/computadorAlerta.png" alt="">
                            </figure>
                        </div>

                        <div class="dirCard">
                            <div class="alertaMaquina">
                                <figure> <img src=".././src/img/icons/alerta1.png"> </figure>
                                <p> CPU acima da média (2 horas)</p>
                            </div>
                        </div>

                    </div>
                    <div class="down-card">
                        <div class="content-card">
                            <p><b>ID:</b> 1234</p>
                            <p><b>Funcionário:</b> Julia Oliveira</p>
                        </div>
                        <div class="up-card">
                            <img src=".././src/img/icons/editar.svg" alt="">
                            <img src=".././src/img/icons/excluir.svg" alt="">
                        </div>
                    </div>
                </div>

                <div class="card open-modal" onclick="alterarComponente('dashCpu')">

                    <div class="down-card cima">
                        <div class="esqCard">
                            <figure class="iconComp">
                                <img src=".././src/img/icons/indicadoresMaquina/computadorCritico.png" alt="">
                            </figure>
                        </div>

                        <div class="dirCard">
                            <div class="alertaMaquina">
                                <figure> <img src=".././src/img/icons/alerta2.png"> </figure>
                                <p> CPU acima da média (8 horas)</p>
                            </div>
                        </div>

                    </div>
                    <div class="down-card">
                        <div class="content-card">
                            <p><b>ID:</b> 1234</p>
                            <p><b>Funcionário:</b> Edu Macedo</p>
                        </div>
                        <div class="up-card">
                            <img src=".././src/img/icons/editar.svg" alt="">
                            <img src=".././src/img/icons/excluir.svg" alt="">
                        </div>
                    </div>
                </div>

                <div class="card open-modal" onclick="alterarComponente('dashCpu')">

                    <div class="down-card cima">
                        <div class="esqCard">
                            <figure class="iconComp">
                                <img src=".././src/img/icons/indicadoresMaquina/computadorBranco.png" alt="">
                            </figure>
                        </div>

                        <div class="dirCard">
                            
                        </div> 
                        </div>

                    </div>
                    <div class="down-card">
                        <div class="content-card">
                            <p><b>ID:</b> 1234</p>
                            <p><b>Funcionário:</b> Pedro Lima</p>
                        </div>
                        <div class="up-card">
                            <img src=".././src/img/icons/editar.svg" alt="">
                            <img src=".././src/img/icons/excluir.svg" alt="">
                        </div>
                    </div>
                </div>
                 -->
            </section>
        </main>

        <!--  MODAL  -->
        <div id="fade" class="hide" onclick="closeModal()"></div>
        <div id="modal" class="hide">
            <div class="btnSair">
                <img src=".././src/img/icons/fechar.svg" alt="ícone para sair do modal" onclick="closeModal()">
                <!-- <h1 class="txtId">ID: <span id="idComputadorModal"> </span></h1> -->

            </div>
            <div class="modal-content">
                <div class="containerModal">
                    <div class="opcoesComponentes menu" id="itens">
                        <h6 class="opcoesMenu" id="cpu" onclick="alterarComponente('dashCpu')"> CPU </h6>
                        <h6 class="opcoesMenu" id="disco" onclick="alterarComponente('dashDisco')"> Disco </h6>
                        <h6 class="opcoesMenu" id="rede" onclick="alterarComponente('dashRede')"> Rede </h6>
                        <h6 class="opcoesMenu" id="memoria" onclick="alterarComponente('dashMemoria')"> Memória</h6>
                        <h6 class="opcoesMenu" id="historico" onclick="alterarComponente('dashHistorico')"> Histórico
                        </h6>
                    </div>

                    <div class="maqInativa">
                        <h3>Não foi possível visualizar o desempenho da máquina: fora de operação.</h2>
                    </div>

                    <div class="aside">
                        <div class="dadosComponente">
                            <div class="infosComponente">
                                <!-- <h6 class="componente" id="idComponente"> CPU </h6> -->
                                <h6 class="nomeComponente" id="idNomeComponente"> nome do componente </h6>
                            </div>
                            <h5 class="monitoramento" id="idMonitoramentoGrafico"> Utilização: </h5>
                        </div>

                        <div class="graficoComponente">
                            <div class="graficoChart">
                                <canvas id="chartDISCO"></canvas>
                                <canvas id="chartREDE"></canvas>
                                <canvas id="chartRAM"></canvas>
                                <canvas id="chartCPU"></canvas>
                            </div>
                        </div>
                    </div>

                    <div id="dashCpu" class="bside">
                        <div class="dado">
                            <h3> Utilização: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="cpuUtilizacao"> -- </span> </h2>
                            </div>
                        </div>
                        <div class="dado">
                            <h3> Média de uso: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="cpuMedia"> -- </span> </h2>
                            </div>
                        </div>
                        <!-- <div class="dado">
                            <h3> Threads: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="cpuThreads"> 2400 </span> </h2>
                            </div>
                        </div>
                        <div class="dado">
                            <h3> Processos: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="cpuProcessos"> 140 </span> </h2>
                            </div>
                        </div>
                        <div class="dado">
                            <h3> Identificadores: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="cpuIdentificadores"> 82750 </span> </h2>
                            </div>
                        </div>
                        <div class="dado">
                            <h3> Tempo de atividade:</h3>
                            <div class="dadoInfo">
                                <h2> <span id="cpuTempoDeAtividade"> 0:08:17:42 </span> </h2>
                            </div>
                        </div> -->
                    </div>
                    <div id="dashDisco" class="bside">
                        <div class="dado">
                            <h3> Utilização: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="discoUtilizacao"> -- </span> </h2>
                            </div>
                        </div>


                        <div class="dado">
                            <h3> Média de uso: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="discoMediaUso"> -- </span> </h2>
                            </div>
                        </div>

                        <!-- <div class="dado">
                            <h3> Tempo médio de resposta: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="discoMediaResposta"> -- </span> </h2>
                            </div>
                        </div> -->
                        <!-- 
                        <div class="dado">
                            <h3> Velocidade de gravação: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="discoGravacao"> 130,2 KB/s </span> </h2>
                            </div>
                        </div> -->
                    </div>
                    <div id="dashRede" class="bside">
                        <div class="dado">
                            <h3> Latência: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="redeLatencia"> -- </span> </h2>
                            </div>
                        </div>

                        <div class="dado">
                            <h3> Pacotes Perdidos: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="redePerdido"> -- </span> </h2>
                            </div>
                        </div>

                        <!-- <div class="dado">
                            <h3> Pacotes Perdidos: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="redePerdido"> -- </span> </h2>
                            </div>
                        </div> -->

                    </div>
                    <div id="dashMemoria" class="bside">

                        <div class="dado">
                            <h3> Utilização: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="memoriaUtilizacao"> -- </span> </h2>
                            </div>
                        </div>

                        <div class="dado">
                            <h3> Média de uso: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="memoriaMedia"> -- </span> </h2>
                            </div>
                        </div>

                        <!-- <div class="dado">
                            <h3> Confirmado: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="memoriaConfirmado"> 10,1/22,7 GB </span> </h2>
                            </div>
                        </div>

                        <div class="dado">
                            <h3> Cache: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="memoriaCache"> 4,6 GB </span> </h2>
                            </div>
                        </div>

                        <div class="dado">
                            <h3> Reserva paginável: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="memoriaPaginavel"> 580 MB </span> </h2>
                            </div>
                        </div>

                        <div class="dado">
                            <h3> Reserva não paginável: </h3>
                            <div class="dadoInfo">
                                <h2> <span id="memoriaNaoPaginavel"> 460 MB </span> </h2>
                            </div>
                        </div> -->
                    </div>
                    <!-- tela de histórico -->
                    <div id="dashHistorico" class="historico">
                        <h3 id="idMaquina">Histórico de alertas da máquina </h3>
                        <div class="filtros">

                            <div class="filtro">
                                <h6>Data do alerta: </h6>
                                <select name="opcoes" class="selectFiltro" id="seletorFiltro">
                                    <option value="total">Sempre</option>
                                    <option value="24h">Últimas 24 horas</option>
                                    <option value="7d">Últimos 7 dias</option>
                                    <option value="30d">Últimos 30 dias</option>
                                    <option value="365d">Últimos 365 dias</option>
                                </select>
                            </div>

                            <div class="filtro">
                                <h6>Gravidade de alerta: </h6>
                                <select name="opcoesAlerta" class="selectFiltro" id="seletorFiltroAlerta">
                                    <option value="total">Todos</option>
                                    <option value="amarelo">Amarelo</option>
                                    <option value="vermelho">Vermelho</option>
                                </select>
                            </div>

                            <div class="filtro">
                                <h6>Componente: </h6>
                                <select name="opcoesAlerta" class="selectFiltro" id="seletorFiltroComponente">
                                    <option value="0">Todos</option>
                                    <option value="4">CPU</option>
                                    <option value="3">Disco</option>
                                    <option value="1">Rede</option>
                                    <option value="2">Memória RAM</option>
                                </select>
                            </div>
                        </div>
                        <div class="listaAlertas">
                            <p>Nenhum alerta emitido.</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</body>
<!-- script do modal -->
<!-- <script src=".././js/modalDispositivo.js"></script> -->
<!-- script do chartJs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<!-- script do apexCHarts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>


</html>

<script>
    var fkEmpresa = sessionStorage.getItem("ID_EMPRESA");
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO

    let idComponente = 0;
    let idComputador = 0;
    let cardId = 0;
    let dadosRecebidos = []; // Variável para armazenar os dados recebidos - funcao de buscar dados inicias
    let intervaloAtivo = null;
    let graficoAtual;

    function sair() {
        sessionStorage.clear()
        window.location = "../index.html"
    }
    // Função para abrir e fechar o modal
    function toggleModal(event) {
        // Verifica se o elemento clicado possui a classe 'cimaCard'
        if (event.target.id === "editar") {
            return;
        }

        const modal = document.querySelector("#modal");
        const fade = document.querySelector("#fade");

        modal.classList.toggle("hide");
        fade.classList.toggle("hide");
        document.body.classList.add("modal-open");
    }

    // Função para fechar o modal clicando fora ou no botão de fechar
    function closeModal() {
        document.getElementById("fade").classList.add("hide");
        document.getElementById("modal").classList.add("hide");
        document.body.classList.remove("modal-open");

    }

    // função pra ativar uma máquina
    function atualizarMaquina(idComputador) {
        editarAlgo = true
        // Redireciona o usuário para a página de edição com o ID do funcionário como parâmetro na URL
        if (confirm("Tem a certeza de que deseja reativar esta máquina?")) {
            // window.location.href = "dispositivos.html"

            fetch(`/maquinas/atualizarMaquina/${idComputador}`, {
                method: "PUT"
            })
                .then(resposta => {
                    if (resposta.ok) {
                        alert("Máquina reativada com sucesso!");
                        atualizarFeed(); // Atualiza a lista após a exclusão
                    } else {
                        throw "Não foi possível reaativar a maquina";
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert("Ocorreu um erro ao tentar reativar a maquina");
                });
        }
    }

    // função pra desativar uma máquina
    function deletar(idComputador) {
        editarAlgo = true
        if (confirm("Tem a certeza de que deseja desativar esta máquina?")) {
            fetch(`/maquinas/deletar/${idComputador}`, {
                method: "PUT"
            })
                .then(resposta => {
                    if (resposta.ok) {
                        alert("Máquina desativada com sucesso!");
                        atualizarFeed(); // Atualiza a lista após a exclusão
                    } else {
                        throw "Não foi possível desativar a maquina";
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert("Ocorreu um erro ao tentar deletar a maquina");
                });
        }
    }

    // função pra listar as máquinas com seus alertas
    function atualizarFeed() {
        var fkEmpresa = sessionStorage.getItem("ID_EMPRESA");

        // ao carregar a página, também plota o gráfico de cima dos componentes por equipes!!
        gerarGraficoEquipes(fkEmpresa)

        // console.log(fkEmpresa);
        fetch(`/dispositivos/listar/${fkEmpresa}`)
            .then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        var feed = document.getElementById("sectioncard");
                        var mensagem = document.getElementById("spanMensagem");
                        mensagem.innerHTML = "Nenhum resultado encontrado.";
                        feed.appendChild(mensagem);
                        throw "Nenhum resultado encontrado!";
                    }

                    return resposta.json();
                } else {
                    throw 'Houve um erro na API!';
                }
            })
            .then(function (resposta) {
                // console.log("Dados recebidos: ", JSON.stringify(resposta));

                var feed = document.getElementById("sectioncard");
                feed.innerHTML = ""; // Limpa o conteúdo atual do feed
                resposta.forEach(publicacao => {
                    var card = document.createElement("div");
                    card.setAttribute("id", publicacao.idComputador); // Define o ID
                    card.classList.add("card"); // Adiciona a classe para o modal

                    // Adicionando o evento para abrir o modal
                    card.addEventListener("click", function () {
                        cardId = this.id;
                        console.log("Card clicado. cardId:", this.id);
                        alterarComponente('dashCpu', this.id);  // Altera o componente
                        toggleModal(event);  // Abre o modal após alterar o componente
                    });

                    // Atualiza o status baseado no valor numérico
                    let status = publicacao.status === 1 ? "Em atividade" : "Inativo";
                    let statusColor = publicacao.status === 1 ? "#12FF39" : "#FF7557";

                    if (publicacao.status === 2) {
                        card.innerHTML = `
                <div class="down-card cima">
                    <div class="esqCard">
                        <figure class="iconComp">
                            <img src=".././src/img/icons/indicadoresMaquina/computadorBranco.png" alt="Ícone do Computador">
                        </figure>
                    </div>
                    <div class="dirCard"></div>
                </div>
                <div class="down-card">
                    <div class="content-card">
                        <p><b>ID:</b> ${publicacao.idComputador}</p>
                        <p><b>Equipe:</b> ${publicacao.fkEquipe}</p>
                        <p><b>Funcionário:</b> ${publicacao.nomeFuncionario}</p>
                        <p><b>Status:</b> <span style="color: ${statusColor};">${status}</span></p>
                    </div>
                    <div class="up-card">
                        <img src=".././src/img/icons/editar.svg" id="editar" alt="Editar" onclick="atualizarMaquina(${publicacao.idComputador})">
                        <img src=".././src/img/icons/excluir.svg" id="editar" alt="Excluir" onclick="deletar(${publicacao.idComputador})">
                    </div>
                </div>
            `;
                    }
                    else {

                        // Defina o ícone do computador com base no tipo de alerta
                        let computadorIcon = ".././src/img/icons/indicadoresMaquina/computadorEstavel.png";
                        if (publicacao.tipoAlerta === 1) {
                            computadorIcon = ".././src/img/icons/indicadoresMaquina/computadorAlerta.png";
                        } else if (publicacao.tipoAlerta === 2) {
                            computadorIcon = ".././src/img/icons/indicadoresMaquina/computadorCritico.png";
                        }

                        // Formatação da mensagem de alerta
                        let alertaMensagem = "";
                        if (publicacao.tipoAlerta) {
                            const componente = publicacao.nomeComponente; // Nome do componente
                            const descricao = publicacao.unidadeMedida; // Descrição do alerta
                            const captura = publicacao.captura; // Valor capturado

                            // Formatar mensagem para exibir "% de uso" de forma amigável
                            if (descricao.toLowerCase().includes("porcen")) {
                                alertaMensagem = `<p>${componente} acima do ideal com ${captura}% de uso</p>`;
                            } else if (descricao.toLowerCase() === "latencia") {
                                alertaMensagem = `<p>${componente} com alta latência (${captura}ms)</p>`;
                            } else if (descricao.toLowerCase() === "pacotesperdidos") {
                                alertaMensagem = `<p>${componente} com perda de pacotes (${captura}%)</p>`;
                            } else {
                                alertaMensagem = `<p>${componente} acima do ideal (${descricao}: ${captura})</p>`;
                            }
                        }

                        // Criação da estrutura do card
                        card.innerHTML = `
                            <div class="down-card cima">
                                <div class="esqCard">
                                    <figure class="iconComp">
                                        <img src="${computadorIcon}" alt="Ícone do Computador">
                                    </figure>
                                </div>
                                ${publicacao.tipoAlerta ? `
                                <div class="dirCard">
                                    <div class="alertaMaquina">
                                        <figure> 
                                            <img src="${publicacao.tipoAlerta === 1 ? '.././src/img/icons/alerta1.png' : '.././src/img/icons/alerta2.png'}" alt="Ícone do Alerta"> 
                                        </figure>
                                        ${alertaMensagem}
                                    </div>
                                </div>` : ''}
                            </div>
                            <div class="down-card">
                                <div class="content-card">
                                    <p><b>ID:</b> ${publicacao.idComputador}</p>
                                    <p><b>Equipe:</b> ${publicacao.fkEquipe}</p>
                                    <p><b>Funcionário:</b> ${publicacao.nomeFuncionario}</p>
                                    <p><b>Status:</b> <span style="color: ${statusColor};">${status}</span></p>
                                </div>
                                <div class="up-card">
                                    <img src=".././src/img/icons/editar.svg" id="editar" alt="Editar" onclick="atualizarMaquina(${publicacao.idComputador})">
                                    <img src=".././src/img/icons/excluir.svg" id="editar" alt="Excluir" onclick="deletar(${publicacao.idComputador})">
                                </div>
                            </div>
                        `;
                    }
                    feed.appendChild(card);
                });
            })
            .catch(function (erro) {
                console.error("Erro ao atualizar o feed:", erro);
            });
    }
    intervaloFeed = setInterval(atualizarFeed, 2000);

    // função pra gerar o gráfico de quantidade de alertas por equipe
    function gerarGraficoEquipes(fkEmpresa) {
        fetch(`/dispositivos/equipes/${fkEmpresa}`)
            .then(response => response.json())
            .then(result => {
                const equipes = [];
                const datasets = {
                    CPU: [],
                    Rede: [],
                    RAM: [],
                    Disco: []
                };

                // Mapeamento de nomes retornados para as chaves corretas do datasets
                const componenteMap = {
                    cpu: 'CPU',
                    rede: 'Rede',
                    memória: 'RAM',
                    disco: 'Disco'
                };

                result.forEach(row => {
                    // console.log('Componente recebido:', row.componente);

                    // Adiciona a equipe ao eixo X se ainda não estiver incluída
                    const equipeLabel = `Equipe ${row.equipe}`
                    if (!equipes.includes(equipeLabel)) {
                        equipes.push(equipeLabel);
                    }

                    // Converte o nome do componente para a chave correta no datasets
                    const datasetKey = componenteMap[row.componente.toLowerCase()];
                    if (datasetKey) {
                        datasets[datasetKey].push(row.qtdAlerta);
                    } else {
                        console.warn(`Componente desconhecido: ${row.componente}`);
                    }
                });

                const data = {
                    labels: equipes,
                    datasets: [
                        {
                            label: 'CPU',
                            data: datasets.CPU,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Rede',
                            data: datasets.Rede,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'RAM',
                            data: datasets.RAM,
                            backgroundColor: 'rgba(75, 192, 192, 0.4)',
                            borderColor: '#4BC0C0',
                            borderWidth: 1
                        },
                        {
                            label: 'Disco',
                            data: datasets.Disco,
                            backgroundColor: 'rgba(153, 102, 255, 0.6)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }
                    ]
                };

                // Criação do gráfico
                const config = {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                align: 'center'
                            }
                        },
                        scales: {
                            x: {
                                stacked: false
                            },
                            y: {
                                beginAtZero: true,
                                max: 20
                            }
                        },
                    }
                };

                // Renderiza o gráfico
                // const ctx = document.getElementById('graficoEquipe').getContext('2d');
                // new Chart(ctx, config);
            })
        // .catch(error => console.error('Erro ao carregar os dados:', error));
    }

    //============== GRÁFICO DE MONITORAMENTO EM TEMPO REAL  ==================================================================================
    function alterarComponente(componenteId, card = cardId) {

        // const idComputadorModal = document.getElementById("idComputadorModal")
        // idComputadorModal.innerHTML = `${idComputador}`

        // Obtém o status da máquina (ativo/inativo)
        const cardElement = document.getElementById(card);
        const status = cardElement.querySelector(".content-card p span").innerText;
        const maqInativaDiv = document.querySelector(".maqInativa");

        const aside = document.querySelector(".aside");
        const dashComponentes = ["dashCpu", "dashDisco", "dashRede", "dashMemoria", "dashHistorico"];
        const graficoIds = ["chartCPU", "chartDISCO", "chartREDE", "chartRAM"];

        // Verifica se a máquina está inativa
        if (status === "Inativo") {
            // Exibe apenas a mensagem de máquina inativa
            maqInativaDiv.style.display = "flex";
            aside.style.display = "none";
            dashComponentes.forEach(id => document.getElementById(id).style.display = "none");
            graficoIds.forEach(id => document.getElementById(id).style.display = "none");
            return; // Sai da função para evitar carregamentos desnecessários
        } else {
            // Oculta a mensagem de máquina inativa e exibe os gráficos normalmente
            maqInativaDiv.style.display = "none";
            aside.style.display = "flex";
        }

        const componentes = {
            "dashCpu": "CPU",
            "dashDisco": "Disco",
            "dashRede": "Rede",
            "dashMemoria": "Memória",
            "dashHistorico": "Histórico de alertas"
        };

        const nomeComponentes = {
            "dashCpu": "Modelo da CPU não obtido.",
            "dashDisco": "Modelo do Disco não obtido.",
            "dashRede": "Modelo da placa de rede não obtido.",
            "dashMemoria": "Armazenamento total não obtido."
        };
        // console.log("ID do componente selecionado: ", componenteId);

        // Esconde a div e os gráficos de todos os componentes
        dashComponentes.forEach(id => {
            const element = document.getElementById(id);
            element.style.display = "none"; // Garante que o elemento existe antes de manipular

        });
        // Esconde todos os gráficos
        graficoIds.forEach(graficoId => {
            const graficoElem = document.getElementById(graficoId);
            graficoElem.style.display = "none"; // Oculta todos os gráficos
        });

        // Define o peso da fonte de todos os elementos
        dashComponentes.forEach(id => {
            const element = document.getElementById(id.replace("dash", "").toLowerCase());
            if (element) {
                element.style.fontWeight = (id === componenteId) ? "700" : "500";
            } else {
                console.log(`Elemento não encontrado para o ID no menu: ${id.replace("dash", "").toLowerCase()}`);
            }
            const elementHist = document.getElementById("dashHistorico");
            if (elementHist) {
                elementHist.style.fontWeight = (id === componenteId) ? "700" : "500";
            } else {
                console.log(`Elemento não encontrado para o ID no menu: ${id.replace("dash", "").toLowerCase()}`);
            }
        });

        // Mostra a div do componente selecionado e o gráfico
        // div: 
        const selectedComponent = document.getElementById(componenteId);
        console.log("Componente a ser exibido: ", selectedComponent);

        if (selectedComponent) {
            selectedComponent.style.display = "grid"; // Garante que o componente é mostrado
        } else {
            console.log(`Elemento não encontrado para o ID: ${componenteId}`);
        }

        // Atualiza o nome do componente no aside
        const componentName = nomeComponentes[componenteId];
        const nomeComponenteElem = document.getElementById("idNomeComponente");
        if (nomeComponenteElem) {
            nomeComponenteElem.innerHTML = componentName;
        } else {
            console.log("Elemento 'idNomeComponente' não encontrado.");
        }

        if (componenteId == "dashCpu") {
            idComponente = 4
        } else if (componenteId == "dashDisco") {
            idComponente = 3
        }
        else if (componenteId == "dashRede") {
            idComponente = 1
        }
        else if (componenteId == "dashMemoria") {
            idComponente = 2
        }


        // grafico:
        // Exibe o gráfico correspondente
        let graficoAtivoId;
        if (componenteId === "dashCpu") {
            graficoAtivoId = "chartCPU";
            idComponente = 4;
        } else if (componenteId === "dashDisco") {
            graficoAtivoId = "chartDISCO";
            idComponente = 3;
        } else if (componenteId === "dashRede") {
            graficoAtivoId = "chartREDE";
            idComponente = 1;
        } else if (componenteId === "dashMemoria") {
            graficoAtivoId = "chartRAM";
            idComponente = 2;
        }
        if (graficoAtivoId) {
            const graficoAtivoElem = document.getElementById(graficoAtivoId);
            if (graficoAtivoElem) {
                graficoAtivoElem.style.display = "flex"; // Exibe o gráfico ativo
            } else {
                console.log(`Gráfico ativo não encontrado: ${graficoAtivoId}`);
            }
        }

        if (componenteId === "dashHistorico") {
            carregarHistoricoAlertas(cardId,);
            return;
        } else {
            obterDadosGrafico(idComponente, cardId)
        }
    }

    // chama a função de carregarHistorico quando algum select de filtro é alterado!
    document.getElementById("seletorFiltro").addEventListener("change", () => {
        carregarHistoricoAlertas(cardId);
    });
    document.getElementById("seletorFiltroAlerta").addEventListener("change", () => {
        carregarHistoricoAlertas(cardId);
    });
    document.getElementById("seletorFiltroComponente").addEventListener("change", () => {
        carregarHistoricoAlertas(cardId);
    });

    function carregarHistoricoAlertas(idComputador = cardId) {

        // filtro pela data, filtro pelo tipo de alerta e por componente!
        const seletorFiltro = document.getElementById("seletorFiltro");
        const seletorFiltroAlerta = document.getElementById("seletorFiltroAlerta");
        const seletorFiltroComponente = document.getElementById("seletorFiltroComponente");

        const filtroSelecionado = seletorFiltro.value;
        const filtroAlerta = seletorFiltroAlerta.value;
        const filtroComponente = seletorFiltroComponente.value;



        let dataFiltro = "";
        const currentDate = new Date();

        // definindo o filtro de data com base na seleção
        if (filtroSelecionado === "24h") {
            currentDate.setHours(currentDate.getHours() - 24);
            dataFiltro = currentDate.toISOString();
        } else if (filtroSelecionado === "7d") {
            currentDate.setDate(currentDate.getDate() - 7);
            dataFiltro = currentDate.toISOString();
        } else if (filtroSelecionado === "30d") {
            currentDate.setDate(currentDate.getDate() - 30);
            dataFiltro = currentDate.toISOString();
        } else if (filtroSelecionado === "365d") {
            currentDate.setFullYear(currentDate.getFullYear() - 1);
            dataFiltro = currentDate.toISOString();
        } else {
            dataFiltro = 0
        }


        if (intervaloAtivo) {
            clearInterval(intervaloAtivo);
            intervaloAtivo = null;
        }
        const aside = document.querySelector(".aside");
        const bside = document.querySelector(".bside");
        const historico = document.getElementById("dashHistorico");
        aside.style.display = 'none';
        bside.style.display = 'none';
        historico.style.display = 'flex';

        fetch(`/dispositivos/historico/${fkEmpresa}/${cardId}/${dataFiltro}/${filtroAlerta}/${filtroComponente}`, {
            cache: 'no-store',
            method: "GET",
        })
            .then(response => {
                console.log(response);
                const listaAlertas = document.querySelector(".listaAlertas");
                const idMaquina = document.getElementById("idMaquina"); // Acha o elemento idMaquina
                const idComputadorModal = document.getElementById("idComputadorModal")

                if (response.ok) {
                    if (response.status == 204) {
                        // Exibe a mensagem quando não há alertas
                        listaAlertas.innerHTML = `Nenhum alerta encontrado.`;
                        idMaquina.innerHTML = `Histórico de alertas da máquina ${idComputador} - Total: 0 alertas.`;
                        idComputadorModal.innerHTML = `${idComputador}`
                        return; // Sai do processamento aqui, já que não há dados
                    }
                    return response.json(); // Retorna o JSON com os alertas
                } else {
                    throw new Error("Erro ao buscar histórico de alertas.");
                }
            })
            .then(alertas => {
                const listaAlertas = document.querySelector(".listaAlertas");
                const idMaquina = document.getElementById("idMaquina");


                // Verifica se a resposta está vazia
                if (alertas.length === 0) {
                    listaAlertas.innerHTML = `Nenhum alerta encontrado.`;
                    idMaquina.innerHTML = `Histórico de alertas da máquina ${idComputador} - Total: ${alertas.length} alertas.`;
                    return; // Sai da função se não houver dados
                }

                // Limpa a lista de alertas para adicionar os novos
                listaAlertas.innerHTML = "";

                // Exibe cada alerta
                alertas.forEach(alerta => {
                    const alertaDiv = document.createElement("div");
                    alertaDiv.classList.add("historicoAlerta");

                    // Formata a mensagem com as cores e negrito
                    const tipoAlerta = alerta.tipoAlerta === 1 ? 'amarelo' : 'vermelho';
                    const componente = alerta.nomeComponente;
                    const captura = alerta.captura;
                    const descricao = alerta.descricao;
                    const dataCaptura = new Date(alerta.dataCaptura);
                    const formattedDate = `${dataCaptura.getDate()}/${dataCaptura.getMonth() + 1}/${dataCaptura.getFullYear()} às ${dataCaptura.getHours()}:${dataCaptura.getMinutes()}:${dataCaptura.getSeconds()}`;

                    const descricaoAdicional = componente.toLowerCase() === 'rede'
                        ? (descricao.toLowerCase() === 'latencia' ? 'latência' : 'pacotes perdidos')
                        : `porcentagem de uso`;

                    const mensagemFormatada = `<p>
                        Alerta <span style="background-color: ${tipoAlerta === 'amarelo' ? '#ffd06c' : '#f34949'}; 
                        border-radius: 9px; 
                        padding: 0 2px; 
                        color: ${tipoAlerta === 'amarelo' ? '#000' : '#fff'};">
                            ${tipoAlerta}
                        </span> 
                        <span style="text-decoration: underline;">em ${formattedDate}</span>
                        em ${descricaoAdicional} do componente <b style="font-weight: bold;">${componente} --> ${captura}</b>.
                    </p>`;
                    alertaDiv.innerHTML = mensagemFormatada;

                    // Atualiza o texto do idMaquina com a quantidade de alertas
                    idMaquina.innerHTML = `Histórico de alertas da máquina ${alerta.idComputador} - Total: ${alertas.length} alertas.`;

                    // Adiciona o alerta à lista
                    listaAlertas.appendChild(alertaDiv);
                });
            })
            .catch(error => {
                console.error("Erro ao carregar histórico:", error);
            });
    }

    // Função para buscar os dados iniciais
    function obterDadosGrafico(idComponente, card = cardId) {

        fetch(`/dispositivos/metrica/${fkEmpresa}/${idComponente}/${card}`, {
            cache: 'no-store',
            method: "GET",
        })
            .then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        // console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        dadosRecebidos = resposta; // Salva os dados recebidos
                        gerarGraficoTempoReal(idComponente, cardId); // Inicia o gráfico
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // função pra instanciar o gráfico com os dados iniciais
    function gerarGraficoTempoReal(idComponente, card = cardId) {
        // console.log(`Gerando gráfico em tempo real para o card: ${cardId} com o idCOmponente = ${idComponente}`);

        const cCpu = document.getElementById('chartCPU');
        const cDisco = document.getElementById('chartDISCO');
        const cRam = document.getElementById('chartRAM');
        const cRede = document.getElementById('chartREDE');

        let idMonitoramentoGrafico = document.getElementById("idMonitoramentoGrafico")
        idMonitoramentoGrafico.innerHTML = "Utilização:"

        if (idComponente == 1) { // rede
            if (window.chartREDE instanceof Chart) {
                window.chartREDE.destroy();
            }
            const ultimosLat = dadosRecebidos.slice(-20).map(item => item.latencia);
            const ultimasDatas = dadosRecebidos.slice(-20).map(item => item.dataCaptura);

            let idMonitoramentoGrafico = document.getElementById("idMonitoramentoGrafico")
            idMonitoramentoGrafico.innerHTML = "Latência:"
            // Inicialização do gráfico vazio
            window.chartREDE = new Chart(cRede, {
                type: 'line',
                data: {
                    labels: ultimasDatas, // Inicialmente vazio
                    datasets: [{
                        label: 'Latência (ms)',
                        data: ultimosLat, // Inicialmente vazio
                        borderWidth: 3,
                        borderColor: "#FF6384",
                        backgroundColor: "rgba(255, 99, 132, 0.2)",
                        tension: 0.4, // Curvatura da linha (0 = reta, 1 = muito curva)
                        pointStyle: 'circle', // Estilo dos pontos (circle, rect, rectRot, triangle, star, etc.)
                        pointRadius: 2, // Tamanho dos pontos na linha
                        pointBorderColor: 'rgba(255, 99, 132, 0.2)', // Cor da borda dos pontos
                        pointBackgroundColor: 'rgba(255, 255, 255, 1)', // Cor de fundo dos pontos
                        pointHoverRadius: 7, // Tamanho dos pontos ao passar o mouse
                        pointHoverBackgroundColor: 'rgba(255, 255, 255, 1)', // Cor de fundo dos pontos ao passar o mouse
                        pointHoverBorderColor: '#FF6384', // Cor da borda dos pontos ao passar o mouse
                        pointHoverBorderWidth: 3, // Espessura da borda dos pontos ao passar o mouse
                        showLine: true, // Mostra ou esconde a linha (false para mostrar apenas os pontos)
                        fill: true, // Preenchimento abaixo da linha (false para desativar)
                        hoverBorderWidth: 3 // Espessura da linha ao passar o mouse
                    }]
                },
                options: {
                    responsive: true, // Torna o gráfico responsivo
                    maintainAspectRatio: false, // Permite ajuste independente da proporção
                    animation: {
                        duration: 800, // Define a duração total da animação em milissegundos
                        easing: 'easeInOutQuad', // Animação  para sincronizar o preenchimento
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)', // Cor da grade no eixo x
                                lineWidth: 1, // Espessura das linhas de grade
                            },
                            ticks: {
                                color: '#000', // Cor das labels do eixo x
                                font: {
                                    size: 14, // Tamanho da fonte das labels
                                    family: 'Arial', // Família da fonte
                                    style: 'italic', // Estilo da fonte
                                }
                            }
                        },
                        y: { // Configurações do eixo y
                            beginAtZero: true, // Inicia o eixo y no valor 0
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)', // Cor da grade no eixo y
                                borderDash: [5, 5], // Estilo tracejado para a grade
                            },
                            ticks: {
                                color: '#000', // Cor das labels do eixo y
                                font: {
                                    size: 12, // Tamanho da fonte das labels
                                    family: 'Verdana', // Família da fonte
                                    weight: 'bold', // Peso da fonte (bold, normal, etc.)
                                }
                            }
                        }
                    },
                    transitions: {
                        active: {
                            animation: {
                                duration: 300 // Reduz o tempo de animação para atualizações dinâmicas
                            }
                        }
                    },
                    plugins: {
                        legend: { // Configurações da legenda
                            display: true, // Mostra ou esconde a legenda
                            position: 'top', // Posição da legenda (top, bottom, left, right)
                            labels: {
                                color: '#FF6384', // Cor do texto da legenda
                                font: {
                                    size: 14, // Tamanho da fonte da legenda
                                    // style: 'bold' // Estilo da fonte da legenda
                                },
                                usePointStyle: true, // Usa o estilo dos pontos como ícones na legenda
                                boxHeight: 10, // Altura do ícone na legenda
                            }
                        },
                        tooltip: { // Configurações dos tooltips (dicas ao passar o mouse)
                            enabled: true, // Ativa/desativa os tooltips
                            backgroundColor: 'rgba(0, 0, 0, 0.6)', // Cor de fundo do tooltip
                            titleColor: '#ffffff', // Cor do título no tooltip
                            bodyColor: '#ffffff', // Cor do texto no tooltip
                            borderColor: '#FF6384', // Cor da borda do tooltip
                            borderWidth: 2, // Espessura da borda do tooltip
                            cornerRadius: 4, // Arredondamento dos cantos do tooltip
                            caretPadding: 5, // Espaço entre o tooltip e o ponto
                            callbacks: { // Funções personalizadas para o conteúdo do tooltip
                                label: function (context) {
                                    return context.raw + '%'; // Adiciona "%" ao valor do dado
                                }
                            }
                        }
                    }
                }
            });
            // Garante que o gráfico foi criado antes de chamar a atualização
            console.log("myChart inicializado:", chartREDE);
            graficoAtual = window.chartREDE;
            atualizarGrafico(idComponente)

        } else if (idComponente == 2) { // memoria RAM
            if (window.chartRAM instanceof Chart) {
                window.chartRAM.destroy();
            }
            const ultimosDados = dadosRecebidos.slice(-20).map(item => item.captura);
            const ultimasDatas = dadosRecebidos.slice(-20).map(item => item.dataCaptura);

            window.chartRAM = new Chart(cRam, {
                type: 'line',
                data: {
                    labels: ultimasDatas, // Inicialmente vazio
                    datasets: [{
                        label: '% de uso',
                        data: ultimosDados, // Inicialmente vazio
                        borderWidth: 3,
                        borderColor: "#228B22",
                        backgroundColor: "rgba(34, 139, 34, 0.3)",
                        tension: 0.4, // Curvatura da linha (0 = reta, 1 = muito curva)
                        pointStyle: 'circle', // Estilo dos pontos (circle, rect, rectRot, triangle, star, etc.)
                        pointRadius: 2, // Tamanho dos pontos na linha
                        pointBorderColor: 'rgba(34, 139, 34, 0.3)', // Cor da borda dos pontos
                        pointBackgroundColor: 'rgba(255, 255, 255, 1)', // Cor de fundo dos pontos
                        pointHoverRadius: 7, // Tamanho dos pontos ao passar o mouse
                        pointHoverBackgroundColor: 'rgba(255, 255, 255, 1)', // Cor de fundo dos pontos ao passar o mouse
                        pointHoverBorderColor: '#228B22', // Cor da borda dos pontos ao passar o mouse
                        pointHoverBorderWidth: 3, // Espessura da borda dos pontos ao passar o mouse
                        showLine: true, // Mostra ou esconde a linha (false para mostrar apenas os pontos)
                        fill: true, // Preenchimento abaixo da linha (false para desativar)
                        hoverBorderWidth: 3 // Espessura da linha ao passar o mouse
                    }]
                },
                options: {
                    responsive: true, // Torna o gráfico responsivo
                    maintainAspectRatio: false, // Permite ajuste independente da proporção
                    animation: {
                        duration: 800, // Define a duração total da animação em milissegundos
                        easing: 'easeInOutQuad', // Animação  para sincronizar o preenchimento
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)', // Cor da grade no eixo x
                                lineWidth: 1, // Espessura das linhas de grade
                            },
                            ticks: {
                                color: '#000', // Cor das labels do eixo x
                                font: {
                                    size: 14, // Tamanho da fonte das labels
                                    family: 'Arial', // Família da fonte
                                    style: 'italic', // Estilo da fonte
                                }
                            }
                        },
                        y: { // Configurações do eixo y
                            beginAtZero: true, // Inicia o eixo y no valor 0
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)', // Cor da grade no eixo y
                                borderDash: [5, 5], // Estilo tracejado para a grade
                            },
                            ticks: {
                                color: '#000', // Cor das labels do eixo y
                                font: {
                                    size: 12, // Tamanho da fonte das labels
                                    family: 'Verdana', // Família da fonte
                                    weight: 'bold', // Peso da fonte (bold, normal, etc.)
                                }
                            }
                        }
                    },
                    transitions: {
                        active: {
                            animation: {
                                duration: 300 // Reduz o tempo de animação para atualizações dinâmicas
                            }
                        }
                    },
                    plugins: {
                        legend: { // Configurações da legenda
                            display: true, // Mostra ou esconde a legenda
                            position: 'top', // Posição da legenda (top, bottom, left, right)
                            labels: {
                                color: '#228B22', // Cor do texto da legenda
                                font: {
                                    size: 14, // Tamanho da fonte da legenda
                                    // style: 'bold' // Estilo da fonte da legenda
                                },
                                usePointStyle: true, // Usa o estilo dos pontos como ícones na legenda
                                boxHeight: 10, // Altura do ícone na legenda
                            }
                        },
                        tooltip: { // Configurações dos tooltips (dicas ao passar o mouse)
                            enabled: true, // Ativa/desativa os tooltips
                            backgroundColor: 'rgba(0, 0, 0, 0.6)', // Cor de fundo do tooltip
                            titleColor: '#ffffff', // Cor do título no tooltip
                            bodyColor: '#ffffff', // Cor do texto no tooltip
                            borderColor: '#228B22', // Cor da borda do tooltip
                            borderWidth: 2, // Espessura da borda do tooltip
                            cornerRadius: 4, // Arredondamento dos cantos do tooltip
                            caretPadding: 5, // Espaço entre o tooltip e o ponto
                            callbacks: { // Funções personalizadas para o conteúdo do tooltip
                                label: function (context) {
                                    return context.raw + '%'; // Adiciona "%" ao valor do dado
                                }
                            }
                        }
                    }
                }
            });
            // Garante que o gráfico foi criado antes de chamar a atualização
            console.log("myChart inicializado:", chartRAM);
            graficoAtual = window.chartRAM;
            atualizarGrafico(idComponente)

        } else if (idComponente == 3) { // disco
            if (window.chartDISCO instanceof Chart) {
                window.chartDISCO.destroy();
            }
            const ultimosDados = dadosRecebidos.slice(-20).map(item => item.captura);
            const ultimasDatas = dadosRecebidos.slice(-20).map(item => item.dataCaptura);

            window.chartDISCO = new Chart(cDisco, {
                type: 'line',
                data: {
                    labels: ultimasDatas, // Inicialmente vazio
                    datasets: [{
                        label: '% de uso',
                        data: ultimosDados, // Inicialmente vazio
                        borderWidth: 3,
                        borderColor: "#4BC0C0",
                        backgroundColor: "rgba(75, 192, 192, 0.4)",
                        tension: 0.4, // Curvatura da linha (0 = reta, 1 = muito curva)
                        pointStyle: 'circle', // Estilo dos pontos (circle, rect, rectRot, triangle, star, etc.)
                        pointRadius: 2, // Tamanho dos pontos na linha
                        pointBorderColor: 'rgba(75, 192, 192, 0.4)', // Cor da borda dos pontos
                        pointBackgroundColor: 'rgba(255, 255, 255, 1)', // Cor de fundo dos pontos
                        pointHoverRadius: 7, // Tamanho dos pontos ao passar o mouse
                        pointHoverBackgroundColor: 'rgba(255, 255, 255, 1)', // Cor de fundo dos pontos ao passar o mouse
                        pointHoverBorderColor: '#4BC0C0', // Cor da borda dos pontos ao passar o mouse
                        pointHoverBorderWidth: 3, // Espessura da borda dos pontos ao passar o mouse
                        showLine: true, // Mostra ou esconde a linha (false para mostrar apenas os pontos)
                        fill: true, // Preenchimento abaixo da linha (false para desativar)
                        hoverBorderWidth: 3 // Espessura da linha ao passar o mouse
                    }]
                },
                options: {
                    responsive: true, // Torna o gráfico responsivo
                    maintainAspectRatio: false, // Permite ajuste independente da proporção
                    animation: {
                        duration: 800, // Define a duração total da animação em milissegundos
                        easing: 'easeInOutQuad', // Animação  para sincronizar o preenchimento
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)', // Cor da grade no eixo x
                                lineWidth: 1, // Espessura das linhas de grade
                            },
                            ticks: {
                                color: '#000',  // Cor das labels do eixo x
                                font: {
                                    size: 14, // Tamanho da fonte das labels
                                    family: 'Arial', // Família da fonte
                                    style: 'italic', // Estilo da fonte
                                }
                            }
                        },
                        y: { // Configurações do eixo y
                            beginAtZero: true, // Inicia o eixo y no valor 0
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)', // Cor da grade no eixo y
                                borderDash: [5, 5], // Estilo tracejado para a grade
                            },
                            ticks: {
                                color: '#000',  // Cor das labels do eixo y
                                font: {
                                    size: 12, // Tamanho da fonte das labels
                                    family: 'Verdana', // Família da fonte
                                    weight: 'bold', // Peso da fonte (bold, normal, etc.)
                                }
                            }
                        }
                    },
                    transitions: {
                        active: {
                            animation: {
                                duration: 300 // Reduz o tempo de animação para atualizações dinâmicas
                            }
                        }
                    },
                    plugins: {
                        legend: { // Configurações da legenda
                            display: true, // Mostra ou esconde a legenda
                            position: 'top', // Posição da legenda (top, bottom, left, right)
                            labels: {
                                color: '#4BC0C0', // Cor do texto da legenda
                                font: {
                                    size: 14, // Tamanho da fonte da legenda
                                    // style: 'bold' // Estilo da fonte da legenda
                                },
                                usePointStyle: true, // Usa o estilo dos pontos como ícones na legenda
                                boxHeight: 10, // Altura do ícone na legenda
                            }
                        },
                        tooltip: { // Configurações dos tooltips (dicas ao passar o mouse)
                            enabled: true, // Ativa/desativa os tooltips
                            backgroundColor: 'rgba(0, 0, 0, 0.6)', // Cor de fundo do tooltip
                            titleColor: '#ffffff', // Cor do título no tooltip
                            bodyColor: '#ffffff', // Cor do texto no tooltip
                            borderColor: '#4BC0C0', // Cor da borda do tooltip
                            borderWidth: 2, // Espessura da borda do tooltip
                            cornerRadius: 4, // Arredondamento dos cantos do tooltip
                            caretPadding: 5, // Espaço entre o tooltip e o ponto
                            callbacks: { // Funções personalizadas para o conteúdo do tooltip
                                label: function (context) {
                                    return context.raw + '%'; // Adiciona "%" ao valor do dado
                                }
                            }
                        }
                    }
                }
            });
            // Garante que o gráfico foi criado antes de chamar a atualização
            console.log("myChart inicializado:", chartDISCO);
            graficoAtual = window.chartDISCO;
            atualizarGrafico(idComponente)
        }
        else if (idComponente == 4) { // cpu
            if (window.chartCPU instanceof Chart) {
                window.chartCPU.destroy();
            }
            const ultimosDados = dadosRecebidos.slice(-20).map(item => item.captura);
            const ultimasDatas = dadosRecebidos.slice(-20).map(item => item.dataCaptura);

            window.chartCPU = new Chart(cCpu, {
                type: 'line',
                data: {
                    labels: ultimasDatas,
                    datasets: [{
                        label: '% de uso',
                        data: ultimosDados,
                        borderWidth: 3, // Espessura da linha
                        borderColor: "rgba(54, 162, 235, 1)", // Cor da borda da linha
                        backgroundColor: "rgba(54, 162, 235, 0.4)", // Preenchimento abaixo da linha
                        tension: 0.4, // Curvatura da linha (0 = reta, 1 = muito curva)
                        pointStyle: 'circle', // Estilo dos pontos (circle, rect, rectRot, triangle, star, etc.)
                        pointRadius: 2, // Tamanho dos pontos na linha
                        pointBorderColor: 'rgba(54, 162, 235, 0.4)', // Cor da borda dos pontos
                        pointBackgroundColor: 'rgba(255, 255, 255, 1)', // Cor de fundo dos pontos
                        pointHoverRadius: 7, // Tamanho dos pontos ao passar o mouse
                        pointHoverBackgroundColor: 'rgba(255, 255, 255, 1)', // Cor de fundo dos pontos ao passar o mouse
                        pointHoverBorderColor: 'rgba(54, 162, 235, 1)', // Cor da borda dos pontos ao passar o mouse
                        pointHoverBorderWidth: 3, // Espessura da borda dos pontos ao passar o mouse
                        showLine: true, // Mostra ou esconde a linha (false para mostrar apenas os pontos)
                        fill: true, // Preenchimento abaixo da linha (false para desativar)
                        hoverBorderWidth: 3 // Espessura da linha ao passar o mouse
                    }]
                },
                options: {
                    responsive: true, // Torna o gráfico responsivo
                    maintainAspectRatio: false, // Permite ajuste independente da proporção
                    animation: {
                        duration: 800, // Define a duração total da animação em milissegundos
                        easing: 'easeInOutQuad', // Animação  para sincronizar o preenchimento
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)', // Cor da grade no eixo x
                                lineWidth: 1, // Espessura das linhas de grade
                            },
                            ticks: {
                                color: '#000', // Cor das labels do eixo x
                                font: {
                                    size: 14, // Tamanho da fonte das labels
                                    family: 'Arial', // Família da fonte
                                    style: 'italic', // Estilo da fonte
                                }
                            }
                        },
                        y: { // Configurações do eixo y
                            beginAtZero: true, // Inicia o eixo y no valor 0
                            grid: {
                                color: 'rgba(200, 200, 200, 0.2)', // Cor da grade no eixo y
                                borderDash: [5, 5], // Estilo tracejado para a grade
                            },
                            ticks: {
                                color: '#000', // Cor das labels do eixo y
                                font: {
                                    size: 12, // Tamanho da fonte das labels
                                    family: 'Verdana', // Família da fonte
                                    weight: 'bold', // Peso da fonte (bold, normal, etc.)
                                }
                            }
                        }
                    },
                    transitions: {
                        active: {
                            animation: {
                                duration: 300 // Reduz o tempo de animação para atualizações dinâmicas
                            }
                        }
                    },
                    plugins: {
                        legend: { // Configurações da legenda
                            display: true, // Mostra ou esconde a legenda
                            position: 'top', // Posição da legenda (top, bottom, left, right)
                            labels: {
                                color: 'rgba(54, 162, 235, 1)', // Cor do texto da legenda
                                font: {
                                    size: 14, // Tamanho da fonte da legenda
                                    // style: 'bold' // Estilo da fonte da legenda
                                },
                                usePointStyle: true, // Usa o estilo dos pontos como ícones na legenda
                                boxHeight: 10, // Altura do ícone na legenda
                            }
                        },
                        tooltip: { // Configurações dos tooltips (dicas ao passar o mouse)
                            enabled: true, // Ativa/desativa os tooltips
                            backgroundColor: 'rgba(0, 0, 0, 0.6)', // Cor de fundo do tooltip
                            titleColor: '#ffffff', // Cor do título no tooltip
                            bodyColor: '#ffffff', // Cor do texto no tooltip
                            borderColor: 'rgba(54, 162, 235, 1)', // Cor da borda do tooltip
                            borderWidth: 2, // Espessura da borda do tooltip
                            cornerRadius: 4, // Arredondamento dos cantos do tooltip
                            caretPadding: 5, // Espaço entre o tooltip e o ponto
                            callbacks: { // Funções personalizadas para o conteúdo do tooltip
                                label: function (context) {
                                    return context.raw + '%'; // Adiciona "%" ao valor do dado
                                }
                            }
                        }
                    }
                }
            });

            // Garante que o gráfico foi criado antes de chamar a atualização
            console.log("myChart inicializado:", chartCPU);
            graficoAtual = window.chartCPU;
            atualizarGrafico(idComponente)
        }
    }

    // função pra atualizar o valor mais recente do gráfico
    function atualizarGrafico(idComponente, card = cardId) {
        let indiceAtual = 0;

        if (intervaloAtivo) {
            clearInterval(intervaloAtivo);
            intervaloAtivo = null;
        }

        intervaloAtivo = setInterval(() => {
            let dadoObtido = [];
            fetch(`/dispositivos/tempo-real/${fkEmpresa}/${idComponente}/${card}`, {
                cache: 'no-store',
                method: "GET",
            })
                .then(function (response) {
                    if (response.ok) {
                        response.json().then(function (resposta) {
                            dadoAtual = resposta; // Atualiza com os dados mais recentes
                            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                            console.log(`Dados recebidos: ${JSON.stringify(resposta.dataCaptura)}`);

                            // Verifica se há dados para adicionar ao gráfico
                            if (dadoAtual.length > 0) {
                                dadoAtual = dadoAtual[0]
                                const momento = dadoAtual.dataCaptura;

                                // Adiciona o novo dado ao gráfico
                                if (idComponente === 1) {
                                    // Rede
                                    let latencia = dadoAtual.latencia;

                                    graficoAtual.data.labels.push(momento);
                                    graficoAtual.data.datasets[0].data.push(latencia);
                                } else {
                                    // Outros componentes (Memória, Disco, CPU)
                                    let temperatura = dadoAtual.captura;
                                    graficoAtual.data.labels.push(momento);
                                    graficoAtual.data.datasets[0].data.push(temperatura);
                                }

                                // Remove o ponto mais antigo se o gráfico exceder 20 pontos
                                if (graficoAtual.data.labels.length > 20) {
                                    graficoAtual.data.labels.shift();
                                    graficoAtual.data.datasets[0].data.shift();
                                    if (graficoAtual.data.datasets.length > 1) {
                                        graficoAtual.data.datasets[1].data.shift(); // Caso tenha múltiplos datasets (como Rede)
                                    }
                                }

                                redeLatencia.innerHTML = `${dadoAtual.latencia}ms`;
                                redePerdido.innerHTML = `${dadoAtual.pctPerd}`;
                                idNomeComponente.innerHTML = dadoAtual.modelo;
                                atualizarCor(redeLatencia, dadoAtual.captura);
                                atualizarCor(redePerdido, dadoAtual.captura);

                                // Atualiza o gráfico
                                graficoAtual.update();

                                // Incrementa o índice para o próximo dado
                                indiceAtual++;

                                // Atualiza os KPIs e cores conforme a captura
                                if (idComponente == 2) { // Memória
                                    memoriaUtilizacao.innerHTML = `${dadoAtual.captura}%`;
                                    idNomeComponente.innerHTML = dadoAtual.modelo;
                                    atualizarCor(memoriaUtilizacao, dadoAtual.captura);
                                } else if (idComponente == 3) { // Disco
                                    discoUtilizacao.innerHTML = `${dadoAtual.captura}%`;
                                    idNomeComponente.innerHTML = dadoAtual.modelo;
                                    atualizarCor(discoUtilizacao, dadoAtual.captura);
                                } else if (idComponente == 4) { // CPU
                                    cpuUtilizacao.innerHTML = `${dadoAtual.captura}%`;
                                    idNomeComponente.innerHTML = dadoAtual.modelo;
                                    atualizarCor(cpuUtilizacao, dadoAtual.captura);
                                }
                            }

                            // // Quando todos os dados forem exibidos, limpa o intervalo
                            // if (indiceAtual >= dadoObtido.length) {
                            //     console.log('Todos os dados foram exibidos.');
                            //     clearInterval(intervaloAtivo);
                            // }
                            atualizarMediaGrafico(idComponente)
                        });
                    } else {
                        console.error('Erro na API ou nenhum dado encontrado');
                    }
                })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });
        }, 3000); // Intervalo de 2 segundos
    }

    // função pra atualizar a cor das KPIs de acordo com o último dado obtido
    function atualizarCor(elemento, valor) {
        if (elemento == redeLatencia) {
            if (valor >= 50) {
                if (valor >= 100) {
                    elemento.style.color = "red";
                } else {
                    elemento.style.color = "yellow";
                }
            } else {
                elemento.style.color = "green";
            }
        }
        else if (elemento == redePerdido) {
            if (valor >= 2) {
                if (valor >= 4) {
                    elemento.style.color = "red";
                } else {
                    elemento.style.color = "yellow";
                }
            } else {
                elemento.style.color = "green";
            }
        }
        else if (valor > 90) {
            elemento.style.color = "red"; // Vermelho
        } else if (valor > 80) {
            elemento.style.color = "yellow"; // Amarelo
        } else {
            elemento.style.color = "green"; // Verde
        }
    }

    // função pra atualizar a KPI de média de acordo com o último dado obtido e os anteriores
    function atualizarMediaGrafico(idComponente) {
        const capturasExibidas = graficoAtual.data.datasets[0].data;
        const soma = capturasExibidas.reduce((acumulador, valor) => acumulador + valor, 0);
        const media = soma / capturasExibidas.length;

        // Atualiza a média conforme o idComponente
        if (idComponente == 2) { // Memória
            atualizarCor(memoriaMedia, media);
            memoriaMedia.innerHTML = `${Math.round(media)}%`;
        } else if (idComponente == 3) { // Disco
            atualizarCor(discoMediaUso, media);
            discoMediaUso.innerHTML = `${Math.round(media)}%`;
        } else if (idComponente == 4) { // CPU
            atualizarCor(cpuMedia, media);
            cpuMedia.innerHTML = `${Math.round(media)}%`;
        }
    }

    // função pra buscar e listar uma máquina específica - barrinha de busca
    function listarPorUsuario() {
        const inputPesquisa = document.getElementById("pesquisar_input").value;

        if (inputPesquisa == '') {
            atualizarFeed()
            return
        }

        if (intervaloFeed) {
            clearInterval(intervaloFeed);
            intervaloFeed = null;
        }

        fetch(`/dispositivos/buscar/${fkEmpresa}/${inputPesquisa}`)
            .then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        var feed = document.getElementById("sectioncard");
                        feed.innerHTML = "";
                        var mensagem = document.createElement("span");
                        mensagem.innerHTML = "Nenhum resultado encontrado.";
                        feed.appendChild(mensagem);
                        throw "Nenhum resultado encontrado!";
                    }
                    return resposta.json();
                } else {
                    throw 'Houve um erro na API!';
                }
            })
            .then(function (resposta) {
                // console.log("Dados recebidos: ", JSON.stringify(resposta));

                var feed = document.getElementById("sectioncard");
                feed.innerHTML = ""; // Limpa o conteúdo atual do feed
                resposta.forEach(publicacao => {
                    var card = document.createElement("div");
                    card.setAttribute("id", publicacao.idComputador); // Define o ID
                    card.classList.add("card"); // Adiciona a classe para o modal

                    // Adicionando o evento para abrir o modal
                    card.addEventListener("click", function () {
                        cardId = this.id;
                        console.log("Card clicado. cardId:", this.id);
                        alterarComponente('dashCpu', this.id);  // Altera o componente
                        toggleModal(event);  // Abre o modal após alterar o componente
                    });

                    // Atualiza o status baseado no valor numérico
                    let status = publicacao.status === 1 ? "Em atividade" : "Inativo";
                    let statusColor = publicacao.status === 1 ? "#12FF39" : "#FF7557";

                    if (publicacao.status === 2) {
                        card.innerHTML = `
                <div class="down-card cima">
                    <div class="esqCard">
                        <figure class="iconComp">
                            <img src=".././src/img/icons/indicadoresMaquina/computadorBranco.png" alt="Ícone do Computador">
                        </figure>
                    </div>
                    <div class="dirCard"></div>
                </div>
                <div class="down-card">
                    <div class="content-card">
                        <p><b>ID:</b> ${publicacao.idComputador}</p>
                        <p><b>Equipe:</b> ${publicacao.fkEquipe}</p>
                        <p><b>Funcionário:</b> ${publicacao.nomeFuncionario}</p>
                        <p><b>Status:</b> <span style="color: ${statusColor};">${status}</span></p>
                    </div>
                    <div class="up-card">
                        <img src=".././src/img/icons/editar.svg" id="editar" alt="Editar" onclick="atualizarMaquina(${publicacao.idComputador})">
                        <img src=".././src/img/icons/excluir.svg" id="editar" alt="Excluir" onclick="deletar(${publicacao.idComputador})">
                    </div>
                </div>
            `;
                    }
                    else {
                        // Defina o ícone do computador com base no tipo de alerta
                        let computadorIcon = ".././src/img/icons/indicadoresMaquina/computadorEstavel.png";
                        if (publicacao.tipoAlerta === 1) {
                            computadorIcon = ".././src/img/icons/indicadoresMaquina/computadorAlerta.png";
                        } else if (publicacao.tipoAlerta === 2) {
                            computadorIcon = ".././src/img/icons/indicadoresMaquina/computadorCritico.png";
                        }

                        // Formatação da mensagem de alerta
                        let alertaMensagem = "";
                        if (publicacao.tipoAlerta) {
                            const componente = publicacao.nomeComponente; // Nome do componente
                            const descricao = publicacao.unidadeMedida; // Descrição do alerta
                            const captura = publicacao.captura; // Valor capturado

                            // Formatar mensagem para exibir "% de uso" de forma amigável
                            if (descricao.toLowerCase().includes("porcen")) {
                                alertaMensagem = `<p>${componente} acima do ideal com ${captura}% de uso</p>`;
                            } else if (descricao.toLowerCase() === "latencia") {
                                alertaMensagem = `<p>${componente} com alta latência (${captura}ms)</p>`;
                            } else if (descricao.toLowerCase() === "pacotesperdidos") {
                                alertaMensagem = `<p>${componente} com perda de pacotes (${captura}%)</p>`;
                            } else {
                                alertaMensagem = `<p>${componente} acima do ideal (${descricao}: ${captura})</p>`;
                            }
                        }

                        // Criação da estrutura do card
                        card.innerHTML = `
                            <div class="down-card cima">
                                <div class="esqCard">
                                    <figure class="iconComp">
                                        <img src="${computadorIcon}" alt="Ícone do Computador">
                                    </figure>
                                </div>
                                ${publicacao.tipoAlerta ? `
                                <div class="dirCard">
                                    <div class="alertaMaquina">
                                        <figure> 
                                            <img src="${publicacao.tipoAlerta === 1 ? '.././src/img/icons/alerta1.png' : '.././src/img/icons/alerta2.png'}" alt="Ícone do Alerta"> 
                                        </figure>
                                        ${alertaMensagem}
                                    </div>
                                </div>` : ''}
                            </div>
                            <div class="down-card">
                                <div class="content-card">
                                    <p><b>ID:</b> ${publicacao.idComputador}</p>
                                    <p><b>Equipe:</b> ${publicacao.fkEquipe}</p>
                                    <p><b>Funcionário:</b> ${publicacao.nomeFuncionario}</p>
                                    <p><b>Status:</b> <span style="color: ${statusColor};">${status}</span></p>
                                </div>
                                <div class="up-card">
                                    <img src=".././src/img/icons/editar.svg" id="editar" alt="Editar" onclick="atualizarMaquina(${publicacao.idComputador})">
                                    <img src=".././src/img/icons/excluir.svg" id="editar" alt="Excluir" onclick="deletar(${publicacao.idComputador})">
                                </div>
                            </div>
                        `;
                    }

                    feed.appendChild(card);
                });
            })
            .catch(function (erro) {
                console.error("Erro ao atualizar o feed:", erro);
            });
    }
</script>